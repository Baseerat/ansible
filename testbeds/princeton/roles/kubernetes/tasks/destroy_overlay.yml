---

- name: stop docker service
  service:
    name: docker
    state: stopped

- name: update k8s_overlay_subnet_first_octect
  shell: "var={{ k8s_overlay_subnet_first_octect_base }};var=$((var+{{ pve_id }}));echo $var"
  register: k8s_overlay_subnet_first_octect

- name: clear docker subnet
  lineinfile:
    path: "{{ docker_defautl_config }}"
    line: 'DOCKER_OPTS="--bip={{ k8s_overlay_subnet_first_octect.stdout }}.{{ vm_id }}.0.1/{{ k8s_overlay_subnet_mask }}"'
    state: absent
  become: true

- name: start docker service
  service:
    name: docker
    state: started

- name: remove br0 from docker0 bridge
  shell: brctl delif docker0 br0
  become: true

- name: delete ovs bridge 'br0'
  openvswitch_bridge:
    bridge: br0
    state: absent
  become: true

- name: remove static route for overlay traffic
  shell: ip route del {{ k8s_overlay_subnet_first_octect.stdout }}.0.0.0/8 dev docker0
  become: true

#- debug:
#    msg: "{{ k8s_overlay_subnet_first_octect.stdout }}"


