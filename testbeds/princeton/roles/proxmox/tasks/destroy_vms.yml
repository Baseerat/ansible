---

- name: remove VM from the {{ inventory_hostname }}-vms group in the inventory file
  lineinfile:
    path: "{{ inventory_file }}"
    line: "{{ proxmox_name_prefix }}{{ proxmox_pve_id }}-{{ proxmox_vm_hostname_prefix }}{{ proxmox_vm_id }} ansible_host={{ proxmox_vm_network_address_prefix }}{{ proxmox_vm_id }} ansible_user={{ proxmox_vm_user }} ansible_ssh_common_args='{{ proxmox_ssh_common_args }}' pve_id={{ proxmox_pve_id }} vm_id={{ proxmox_vm_id }}"
    state: absent
  delegate_to: localhost

- name: remove {{ inventory_hostname }}-vms group from the inventory file
  lineinfile:
    path: "{{ inventory_file }}"
    line: "[{{ inventory_hostname }}-vms]"
    state: absent
  delegate_to: localhost

- name: stop VM
  proxmox_kvm:
    state: stopped
    node: "{{ inventory_hostname }}"
    api_user: "{{ proxmox_api_user }}"
    api_password: "{{ proxmox_api_password }}"
    api_host: "{{ hostvars[inventory_hostname]['ansible_default_ipv4']['address'] }}"
    name: "{{ proxmox_name_prefix }}{{ proxmox_pve_id }}-{{ proxmox_vm_hostname_prefix }}{{ proxmox_vm_id }}"
    vmid: "{{ proxmox_vm_id }}"
  delegate_to: localhost

- name: destroy VM
  proxmox_kvm:
    state: absent
    node: "{{ inventory_hostname }}"
    api_user: "{{ proxmox_api_user }}"
    api_password: "{{ proxmox_api_password }}"
    api_host: "{{ hostvars[inventory_hostname]['ansible_default_ipv4']['address'] }}"
    name: "{{ proxmox_name_prefix }}{{ proxmox_pve_id }}-{{ proxmox_vm_hostname_prefix }}{{ proxmox_vm_id }}"
    vmid: "{{ proxmox_vm_id }}"
  delegate_to: localhost

#- debug:
#    msg: "{{ groups }}"